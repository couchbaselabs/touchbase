<!doctype HTML>

<html>
<body>
	<h2>Part 5: Graphing</h2>

	<h4>Necessary Materials:</h4>
	<ul>
		<li>Node.js</li>
		<li>Express</li>
		<li>Chart.js</li>
	</ul>

	<h4>Node Modules Used:</h4>
	<ul>
		<li>tc-angular-chartjs</li>
		<li>body-parser</li>
		<li>moment.js</li>
	</ul>

	<h4> Summary: </h4>

	<p>One of the most fundamental thing a social network must do, is track information about its users. This is done in many different ways to optimize usage of these networks for the consumers, as well as for security concerns. Since this application concerns itself primarily with the basic bones of a social network, we use some graphing to analyze data we are collecting about the user.</p>

	<p>From the start we discussed the &#39;timeTracker&#39; object within each user document. This had a &#39;loginTimes&#39; attribute which we have been continually updating during every login with the <strong>&#39;/api/loginAuth&#39;</strong> endpoint. If this is new to you, refer back to <a href="">part 2</a> where this endpoint was discussed at length. In essence, this endpoint continually prepends the latest time the user logs in to the array &#39;loginTimes&#39;. This is the data we will analyze using a N1QL query, as well a Chart.js adaptation for Angular.js (tc-angular-chartjs), to display the information retrieved from the N1QL date query.</p>

	<p>Below, one can see the statistics endpoint which is used to retrieve the data from each user&#39;s &#39;loginTimes&#39; attribute to then generate a graph.</p>

	<h4>&#39;/api/graphData&#39; API</h4>

	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">get</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;/api/graphData&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">Session</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">auth</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">Statistics</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">newGraph</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">query</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">timeUnit</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">400</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">json</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">);</span>
        <span style="color: #f8f8f2">});</span>
    <span style="color: #f8f8f2">});</span>
	</pre></div>

	<p>This endpoint takes in one argument, which is the scope of time which should be displayed. In this case, the function either accepts &#39;day&#39; or &#39;week&#39;. This will return an array of either 24 integer values (&#39;day&#39;), or 7 integer values (&#39;week&#39;) depending on which type of date range is specified. The function that gets all of this data is <strong>&#39;Statistics.newGraph&#39;</strong>, which will create a N1QL query to get the values we desire. The function is shown below. </p>

	<h4>&#39;Statistics.newGraph&#39; function</h4>
	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">Statistics</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">newGraph</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">timeUnit</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">graphObj</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{};</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dayQuery</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">N1qlQuery</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">fromString</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;SELECT DATE_DIFF_STR(STR_TO_UTC(NOW_STR()), time, \&quot;hour\&quot;) AS deltaTime, COUNT(*) AS countTime from &quot;</span><span style="color: #f92672">+</span><span style="color: #a6e22e">userBucketName</span><span style="color: #f92672">+</span><span style="color: #e6db74">&quot; UNNEST timeTracker.loginTimes AS time GROUP BY DATE_DIFF_STR(STR_TO_UTC(NOW_STR()), time, \&quot;hour\&quot;) HAVING DATE_DIFF_STR(STR_TO_UTC(NOW_STR()), time, \&quot;hour\&quot;) &lt; 24 ORDER BY deltaTime&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">weekQuery</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">N1qlQuery</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">fromString</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;SELECT DATE_DIFF_STR(STR_TO_UTC(NOW_STR()), time, \&quot;day\&quot;) AS deltaTime, COUNT(*) AS countTime from &quot;</span><span style="color: #f92672">+</span><span style="color: #a6e22e">userBucketName</span><span style="color: #f92672">+</span><span style="color: #e6db74">&quot; UNNEST timeTracker.loginTimes AS time GROUP BY DATE_DIFF_STR(STR_TO_UTC(NOW_STR()), time, \&quot;day\&quot;) HAVING DATE_DIFF_STR(STR_TO_UTC(NOW_STR()), time, \&quot;day\&quot;) &lt; 7 ORDER BY deltaTime&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">timeUnit</span> <span style="color: #f92672">===</span> <span style="color: #e6db74">&#39;day&#39;</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">userBucket</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">query</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">dayQuery</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>
                <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">null</span><span style="color: #f8f8f2">);</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">logins</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Array.</span><span style="color: #a6e22e">apply</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">Array(</span><span style="color: #ae81ff">24</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(Number.</span><span style="color: #a6e22e">prototype</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">valueOf</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
            <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">x</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Array.</span><span style="color: #a6e22e">apply</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">Array(</span><span style="color: #ae81ff">24</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(Number.</span><span style="color: #a6e22e">prototype</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">valueOf</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
            <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">hoursX</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;12am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;1am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;2am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;3am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;4am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;5am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;6am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;7am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;8am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;9am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;10am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;11am&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;12pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;1pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;2pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;3pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;4pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;5pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;6pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;7pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;8pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;9pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;10pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;11pm&#39;</span><span style="color: #f8f8f2">];</span>
            <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">counter</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
            <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">starter</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">moment</span><span style="color: #f8f8f2">().</span><span style="color: #a6e22e">hour</span><span style="color: #f8f8f2">();</span>
            <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">starter</span><span style="color: #f8f8f2">);</span>
            <span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">counter</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">24</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">index</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
                <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">((</span><span style="color: #a6e22e">starter</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #a6e22e">index</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">starter</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">24</span><span style="color: #f8f8f2">;</span>
                <span style="color: #f8f8f2">}</span>
                <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #a6e22e">index</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">starter</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">;</span>
                <span style="color: #f8f8f2">}</span>
                <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">x</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">23</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">hoursX</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">index</span><span style="color: #f8f8f2">];</span>
                <span style="color: #a6e22e">counter</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">logins</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">23</span><span style="color: #f92672">-</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">deltaTime</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">countTime</span><span style="color: #f8f8f2">;</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">);</span>
        <span style="color: #f8f8f2">});</span>
    <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">else</span> <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">timeUnit</span> <span style="color: #f92672">===</span> <span style="color: #e6db74">&#39;week&#39;</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">userBucket</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">query</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">weekQuery</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>
                <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">null</span><span style="color: #f8f8f2">);</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">logins</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Array.</span><span style="color: #a6e22e">apply</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">Array(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(Number.</span><span style="color: #a6e22e">prototype</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">valueOf</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
            <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">x</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Array.</span><span style="color: #a6e22e">apply</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">Array(</span><span style="color: #ae81ff">7</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(Number.</span><span style="color: #a6e22e">prototype</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">valueOf</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
            <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">weekX</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;Sunday&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;Monday&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;Tuesday&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;Wednesday&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;Thursday&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;Friday&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;Saturday&#39;</span><span style="color: #f8f8f2">];</span>
            <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">counter</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
            <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">starter</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">moment</span><span style="color: #f8f8f2">().</span><span style="color: #a6e22e">day</span><span style="color: #f8f8f2">();</span>
            <span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">counter</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">7</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">index</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
                <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">((</span><span style="color: #a6e22e">starter</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #a6e22e">index</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">starter</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">7</span><span style="color: #f8f8f2">;</span>
                <span style="color: #f8f8f2">}</span>
                <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #a6e22e">index</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">starter</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">;</span>
                <span style="color: #f8f8f2">}</span>
                <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">x</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">6</span><span style="color: #f92672">-</span><span style="color: #a6e22e">counter</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">weekX</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">index</span><span style="color: #f8f8f2">];</span>
                <span style="color: #a6e22e">counter</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">logins</span><span style="color: #f8f8f2">[</span><span style="color: #ae81ff">6</span><span style="color: #f92672">-</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">deltaTime</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">countTime</span><span style="color: #f8f8f2">;</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">graphObj</span><span style="color: #f8f8f2">);</span>
        <span style="color: #f8f8f2">});</span>
    <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;please enter a valid timeUnit&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">null</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>
	<span style="color: #f8f8f2">};</span>
	</pre></div>

	<p>This incredibly long function is actually doing something very simple. There are three parts to this: </p>

	<ol>
		<li>Check the date range of &#39;week&#39; or &#39;day&#39;</li>
		<li>Execute N1QL query to group data by the last 7 days or the last 24 hours</li>
		<li>Use moment.js and arrays to create the proper order of the x-axis</li>
	</ol>

	<p>The first part of this is accomplished simply using &#39;if/else&#39; statements. The next part gets slightly more complicated, so we will take a second to break down the N1QL query that is being executed, and how we understand what data it will retrieve for us.</p>

	<h4>N1QL date query example for past day</h4>

	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">SELECT</span> <span style="color: #f8f8f2">DATE_DIFF_STR(STR_TO_UTC(NOW_STR()),</span> <span style="color: #f8f8f2">time,</span> <span style="color: #e6db74">&quot;hour&quot;</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">AS</span> <span style="color: #f8f8f2">deltaTime,</span> <span style="color: #66d9ef">COUNT</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">AS</span> <span style="color: #f8f8f2">countTime</span> <span style="color: #66d9ef">from</span> <span style="color: #f8f8f2">users</span> <span style="color: #66d9ef">UNNEST</span> <span style="color: #f8f8f2">timeTracker.loginTimes</span> <span style="color: #66d9ef">AS</span> <span style="color: #f8f8f2">time</span> <span style="color: #66d9ef">GROUP</span> <span style="color: #66d9ef">BY</span> <span style="color: #f8f8f2">DATE_DIFF_STR(STR_TO_UTC(NOW_STR()),</span> <span style="color: #f8f8f2">time,</span> <span style="color: #960050; background-color: #1e0010">\</span><span style="color: #e6db74">&quot;hour\&quot;</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">HAVING</span> <span style="color: #f8f8f2">DATE_DIFF_STR(STR_TO_UTC(NOW_STR()),</span> <span style="color: #f8f8f2">time,</span> <span style="color: #e6db74">&quot;hour&quot;</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">24</span> <span style="color: #66d9ef">ORDER</span> <span style="color: #66d9ef">BY</span> <span style="color: #f8f8f2">deltaTime;</span> 
	</pre></div>

	<p>The way to look at it is that we first unnest all of the array elements into their own separate objects. In this way we can observe each one individually. After we <strong>UNNEST</strong> them, we find out how many hours ago this login time occured, from the time of the API request, which is done using <strong>DATE_DIFF_STR(STR_TO_UTC(NOW_STR())</strong>. We then take each of these times and <strong>GROUP BY</strong> how long ago they occured. Based on these groups, we get a <strong>COUNT</strong> of the number of times that are in that group (how many of these logins occured per hour). This gives us an array of objects that contain the number of hours ago these times occured, and a count that describes how many logins occured this many hours ago. Once we have this, we create a <strong>HAVING</strong> clause that checks to make sure the number of hours ago these happened does not exceed 24, so that we simply get one day, no more, no less. This now gives us exactly what we needed, which is an array of objects stratified by the number of hours ago each of these logins happened, as well as how many logins happened.</p>

	<p>After this, we take the array of objects, and place the login counts into an array, which is indexed based on the hour at which they happened. This array is initialized with 0s, such that there is no error with graphing undefined values. Once this is done, the process of handling data from the N1QL query is complete.</p>

	<p>That takes care of a bulk of the work, and now all we have to do is simply match these up with the proper hours and dates accordingly. We use a predefined array of either <strong>&#39;hoursX&#39;</strong> or <strong>&#39;daysX&#39;</strong> and loop through it to create the proper x-axis. Using the current day, which is found by moment.js, we then create a successful iterative pattern to find the according days and weeks. When we use the moment.js function for <strong>&#39;moment().day();&#39;</strong>, etc. we retrieve a day or hour indexed starting at 1. This is accounted for in the iterative pattern.</p>

	<p>Once both of these arrays are created/obtained, there is no more work to be done, other than on the front-end. We simply return these two arrays to the API endpoint in the form of <strong>&#39;graphObj&#39;</strong> and then send them back to the client in our <strong>&#39;/api/graphData&#39;</strong> endpoint. This completes the back-end work. A set of example code of using this with tc-angular-chartjs can be seen in the github repo in <strong>touchbase.js</strong> under &#39;statisticsController&#39;, and the HTML for it can be seen in statistics-partial.html.</p>

	<p>That concludes the graphing portion of the Touchbase tutorial. I hope that it was helpful, but either way, please drop a comment below with any feedback or criticism. Thanks for reading, and I hope you have an easier time making beautiful charts using N1QL date queries and a great front-end graphing API!</p>


</body>
</html>