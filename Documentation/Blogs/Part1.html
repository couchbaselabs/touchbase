<!doctype HTML>
<html>
<body>
	<h2>Part 1: Register a User</h2>

	<h4>Necessary Materials</h4>
	<ul>
		<li>Node.js</li>
		<li>Express.js</li>
	</ul>

	<h4>Node Modules used</h4>
	<ul>
		<li>Couchbase Node.js SDK/N1QL</li>
		<li>body-parser</li>
		<li>uuid</li>
		<li>node-forge</li>
	</ul>
	
	<p>The most important part of building a social network begins with the users. If you just have a directory of people, you are looking at the most basic form of a social network, by just having a way people can learn about each other.In this way, the most critical thing a user needs to be able to do is create an account. After this point, the rest of our challenges become manipulating this user document, or at least some aspects of it. Before I go further into depth about this, let me explain the basic file structure that exists in this application, which will be critical in understanding how everything operates.</p>

	<h4>File Structure</h4>

	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">
	<span style="color: #f8f8f2">app.js</span>	<span style="color: #75715e">//contains our basic setup for the app</span>
	<span style="color: #f8f8f2">package.json</span>	<span style="color: #75715e">//contains necessary node modules for app</span>
	<span style="color: #f8f8f2">bower.json</span>	<span style="color: #75715e">// contains necessary bower components for app</span>
	<span style="color: #f8f8f2">config.json</span>	<span style="color: #75715e">// contains necessary configuration info for app</span>
	<span style="color: #f92672">/</span><span style="color: #f8f8f2">routes</span>	<span style="color: #75715e">//contains the API endpoints for node (where back-end data is received)</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">routes.js</span> 
	<span style="color: #f92672">/</span><span style="color: #f8f8f2">models</span> <span style="color: #75715e">//contains all functions to complete back-end operations, divided by type</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">picturemodel.js</span> 
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">sessionmodel.js</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">statisticsmodel.js</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">usermodel.js</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">publishmodel.js</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">emailmodel.js</span>
	<span style="color: #f92672">/</span><span style="color: #f8f8f2">icons</span>	<span style="color: #75715e">//contains all our icons</span>
	<span style="color: #f92672">/</span><span style="color: #f8f8f2">bower_components</span> <span style="color: #75715e">//where all bower components get saved using bower install</span>
	<span style="color: #f92672">/</span><span style="color: #f8f8f2">node_modules</span> <span style="color: #75715e">//where all node modules get stored using npm install</span>
	<span style="color: #f92672">/</span><span style="color: #f8f8f2">public</span>	<span style="color: #75715e">//where all front-end materials are stored</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">js</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">html</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">index.html</span>
		<span style="color: #f92672">--</span><span style="color: #f8f8f2">nav.html</span>
	</pre></div>

	<p>I will assume a general proficiency with this file structure, but if you are very new to it, please refer to Nic Raboy&#39;s tutorial on creating a game API with Node.js and Couchbase <a href="http://blog.couchbase.com/making-a-game-api-server-using-nodejs-revisited">here.</a></p>

	<p>In our app.js file, we will have done much of the necessary setup. For this post, I will ask you to first refer to <strong>routes/routes.js</strong>. Here one will find the <strong>&#39;/api/registerUser&#39;</strong> endpoint. For anyone very new to Node.js or API-based applications, an endpoint is simply where a REST API call will transmit its data on the back-end. For example, if i made some sort of http POST request on the front-end to an endpoint called <strong>&#39;/api/registerUser&#39;</strong>, I could send some data (or not) to this endpoint, and it will perform the necessary operations on the back-end before transmitting back some message (typically, a JSON object).</p>

	<h4>&#39;/api/registerUser&#39; API</h4>

	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">post</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">"/api/registerUser"</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">);</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">email</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"An email must be provided"</span><span style="color: #f8f8f2">}));</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">endsWith</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">str</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">suffix</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">str</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">indexOf</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">suffix</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">str</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span> <span style="color: #f92672">-</span> <span style="color: #a6e22e">suffix</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">!==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">endsWith</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">email</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">'couchbase.com'</span><span style="color: #f8f8f2">))</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"Email must end with \"couchbase.com\""</span><span style="color: #f8f8f2">}));</span>   
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">primaryAttribute</span><span style="color: #f8f8f2">])</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"A "</span> <span style="color: #f92672">+</span> <span style="color: #a6e22e">primaryAttribute</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">" must be provided"</span><span style="color: #f8f8f2">}));</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">password</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"A password must be provided"</span><span style="color: #f8f8f2">}));</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">confPassword</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"A password confirmation must be provided"</span><span style="color: #f8f8f2">}));</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">passCheck</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">/(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/</span><span style="color: #f8f8f2">;</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">passCheck</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">test</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">password</span><span style="color: #f8f8f2">))</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"Password must contain 1 lower case character, 1 upper case character, 1 number and at least 6 total characters"</span><span style="color: #f8f8f2">}));</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">password</span> <span style="color: #f92672">!==</span> <span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">confPassword</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">JSON</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringify</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"Password did not match confirmation password"</span><span style="color: #f8f8f2">}));</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #75715e">// replace with advancedSearch</span>
        <span style="color: #a6e22e">User</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">advancedSearch</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">user</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">400</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">user</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span> <span style="color: #f92672">===</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">({</span><span style="color: #e6db74">"status"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"error"</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">"message"</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"This email is already in use. Login, or create an account with a different email address."</span><span style="color: #f8f8f2">});</span>
            <span style="color: #f8f8f2">}</span>
            <span style="color: #a6e22e">User</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">create</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">400</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>
                <span style="color: #f8f8f2">}</span>
                <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">pathInfo</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{};</span>
                <span style="color: #a6e22e">pathInfo</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">protocol</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">protocol</span><span style="color: #f8f8f2">;</span>
                <span style="color: #a6e22e">pathInfo</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">host</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">req</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">headers</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">host</span><span style="color: #f8f8f2">;</span>
                <span style="color: #a6e22e">Session</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">makeVerification</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">pathInfo</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">resp</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                        <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">400</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">);</span>
                    <span style="color: #f8f8f2">}</span>
                    <span style="color: #a6e22e">res</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">json</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">resp</span><span style="color: #f8f8f2">);</span>
                	<span style="color: #f8f8f2">});</span>
            	<span style="color: #f8f8f2">});</span>
        	<span style="color: #f8f8f2">});</span>
    	<span style="color: #f8f8f2">});</span>
	</pre></div>

	<p>In this case, the <strong>/api/registerUser&#39;</strong> endpoint will receive a formData-type object which will contain the contents of a form that the user had filled to register for our site, Touchbase. On the back-end I perform some basic validation to make sure that necessary user information has been input into this account to make sure it can be used as a legitimate account. I assure that it has a name, email, and password. These are all checked on the front-end as well, and display error messages, however, it is never enough to trust the front-end validation, as front-end javascript can be easily manipulated. There is also validation with a regular expression to make sure that the password is strong enough, and then the password is checked against the confirmation password to make sure they are identical. Then, the email is also checked to make sure that it has not already been put in use before using <strong>User.advancedSearch</strong> (this function will be explained at length soon; patience :D ). If all these conditions are met, the <strong>User.create</strong> function is executed.</p>

	<p>To see the User.create function, go to <strong>models/usermodel.js</strong>. In this file you will see a function called <strong>User.create</strong>. This function is used to generate a JSON document that outlines different aspects of the user. As you may notice, some of these aspects come directly from the user input, which was passed to the <strong>User.create</strong> function as <strong>&#39;params&#39;</strong>, while others are generated upon the document&#39;s creation without any input from the user. For example, a random UUID (universally unique identifier) is created as the user&#39;s document ID; learn more <a href="http://searchsoa.techtarget.com/definition/UUID">here</a>. For this, I used the uuid node module <a href="https://github.com/defunctzombie/node-uuid">here</a>. This document ID should be a unique way to identify the user for all future purposes. Because we want to make sure that each document is completely unique, we use a UUID, and because we want to ensure that the document can be as flexible as possible, we avoid using any particular use attribute as the document ID. In the future, we will primarily search these users by attribute, and we will rarely ever be directly using these UUIDs, unless it is in a case that we know we are searching for one specific user.</p>

	<p>We also want to maintain the time the user document was generated, and look at the logins over time, so we use the current time, which we generate using Javascript, to insert these into our timeTracker nested object. You may notice that these variables are also split up oddly by stringAttributes, dropdownAttributes and arrayAttributes. The reason for this, is mainly because of how we will query these attributes using Couchbase&#39;s N1QL query language. This is explained in depth in <a href="">part 0</a> of the blog series, but in essence, the reason it is structured this way is to allow for the code to be changed very little to repurpose it. Within login, you will also see the attribute password&#39; which is a hashed version of the password that the user entered. This is done using node-forge which you can see <a href="https://github.com/digitalbazaar/forge">here</a>.</p>

	<h4>&#39;User.create&#39; function</h4>
	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">User</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">create</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">currentTime</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Date().</span><span style="color: #a6e22e">toISOString</span><span style="color: #f8f8f2">();</span>	
	<span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">'params: '</span> <span style="color: #f92672">+</span> <span style="color: #a6e22e">params</span><span style="color: #f8f8f2">);</span>
	<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">stringToArray</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">anyString</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">typeof</span> <span style="color: #a6e22e">anyString</span> <span style="color: #f92672">===</span> <span style="color: #e6db74">"undefined"</span> <span style="color: #f92672">||</span> <span style="color: #f92672">!</span><span style="color: #a6e22e">anyString</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
			<span style="color: #66d9ef">return</span> <span style="color: #e6db74">""</span><span style="color: #f8f8f2">;</span>
		<span style="color: #f8f8f2">}</span>
		<span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
			<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">tempArray</span><span style="color: #f92672">=</span><span style="color: #a6e22e">anyString</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">split</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">","</span><span style="color: #f8f8f2">);</span>
			<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">resultArray</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[];</span>
			<span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">tempArray</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
				<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">str</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">tempArray</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">];</span>
				<span style="color: #a6e22e">resultArray</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">=</span> <span style="color: #a6e22e">str</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">trim</span><span style="color: #f8f8f2">();</span>
				<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">resultArray</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">==</span><span style="color: #e6db74">""</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
					<span style="color: #a6e22e">resultArray</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">splice</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
				<span style="color: #f8f8f2">}</span>
			<span style="color: #f8f8f2">}</span>
			<span style="color: #66d9ef">return</span> <span style="color: #a6e22e">resultArray</span><span style="color: #f8f8f2">;</span>
		<span style="color: #f8f8f2">}</span>
	<span style="color: #f8f8f2">};</span>
	<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">arrayAttributes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">arrayAttributes</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{};</span>
	<span style="color: #f8f8f2">}</span>
	<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">dropdownAttributes</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{};</span>
	<span style="color: #f8f8f2">}</span>
	<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">!</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringAttributes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
		<span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringAttributes</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{};</span>
	<span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">userDoc</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span>
    	<span style="color: #75715e">// should add a type here, ex. type: "user"</span>
    	<span style="color: #a6e22e">uuid</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">uuid</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">v4</span><span style="color: #f8f8f2">(),</span>
    	<span style="color: #a6e22e">password</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">forge</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">md</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">sha1</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">create</span><span style="color: #f8f8f2">().</span><span style="color: #a6e22e">update</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">password</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">digest</span><span style="color: #f8f8f2">().</span><span style="color: #a6e22e">toHex</span><span style="color: #f8f8f2">(),</span>
    	<span style="color: #a6e22e">stringAttributes</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{},</span>
    	<span style="color: #a6e22e">arrayAttributes</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{},</span>
    	<span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{},</span>
        <span style="color: #a6e22e">login</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        	<span style="color: #a6e22e">type</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"user"</span><span style="color: #f8f8f2">,</span>
	        <span style="color: #a6e22e">email</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">login</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">email</span><span style="color: #f8f8f2">,</span>
	        <span style="color: #a6e22e">administrator</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">,</span>
	        <span style="color: #a6e22e">hasPicture</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">,</span>
	        <span style="color: #a6e22e">emailVerified</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">false</span>
	    <span style="color: #f8f8f2">},</span>
	    <span style="color: #a6e22e">timeTracker</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
	        <span style="color: #a6e22e">registerTime</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">currentTime</span><span style="color: #f8f8f2">,</span>
	        <span style="color: #a6e22e">updateTimes</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[],</span>
	        <span style="color: #a6e22e">loginTimes</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #a6e22e">currentTime</span><span style="color: #f8f8f2">]</span>
    	<span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">};</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">stringAttributes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    	<span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">stringAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">]]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">stringAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">stringAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">i</span><span style="color: #f8f8f2">]];</span>
    <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">j</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">j</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">arrayAttributes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">j</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    	<span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">arrayAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">arrayAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">j</span><span style="color: #f8f8f2">]]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">stringToArray</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">arrayAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">arrayAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">j</span><span style="color: #f8f8f2">]]);</span>
    <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">k</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">k</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">k</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    	<span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">k</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">varname</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">dropdownAttributes</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">k</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">varname</span><span style="color: #f8f8f2">];</span>
    <span style="color: #f8f8f2">}</span>
    <span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">primaryAttribute</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">params</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">primaryAttribute</span><span style="color: #f8f8f2">];</span>
    <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">);</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">insertUser</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">N1qlQuery</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">fromString</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">'INSERT INTO '</span> <span style="color: #f92672">+</span> <span style="color: #a6e22e">userBucketName</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">' (KEY, VALUE) VALUES ($1, $2)'</span><span style="color: #f8f8f2">);</span>
    <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">insertUser</span><span style="color: #f8f8f2">);</span>
    <span style="color: #a6e22e">userBucket</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">query</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">insertUser</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[</span><span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">uuid</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">],</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    	<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    		<span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">"ERROR IN USERMODEL QUERY: "</span><span style="color: #f8f8f2">);</span>
    		<span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">);</span>
    		<span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">err</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">null</span><span style="color: #f8f8f2">);</span>
    		<span style="color: #66d9ef">return</span><span style="color: #f8f8f2">;</span>
    	<span style="color: #f8f8f2">}</span>
    	<span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">{</span><span style="color: #a6e22e">message</span><span style="color: #f92672">:</span> <span style="color: #e6db74">"success"</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">userID</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">uuid</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">userDoc</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">userDoc</span><span style="color: #f8f8f2">});</span>
	    <span style="color: #f8f8f2">});</span>
	<span style="color: #f8f8f2">};</span>
	</pre></div>

	<p>We now use a N1QL insert statement to create the document. Upon error, you will see that a callback function is called. You will notice, that there is a callback passed in as a parameter, which is the <strong>&#39;function(error, result)&#39;</strong> which you see in the <strong>routes/routes.js</strong> file. This is used to avoid having to repeatedly write the same syntax to handle success and errors. If the insert is successful (the result that should occur), then the result will be passed back to the <strong>routes/routes.js</strong> function for <strong>&#39;/api/registerUser&#39;</strong>, and it will continue to be used for further action. After this we see that this is passed to <strong>&#39;Session.makeVerification&#39;</strong>. </p>

	<h4>N1QL &#39;User Insert&#39; Query</h4>
	<!-- HTML generated using hilite.me --><div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">INSERT</span> <span style="color: #66d9ef">INTO</span>  <span style="color: #f8f8f2">users</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">KEY</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">VALUE)</span> <span style="color: #66d9ef">VALUES</span> <span style="color: #f8f8f2">(</span><span style="color: #ae81ff">$1</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">$2</span><span style="color: #f8f8f2">);</span>
	</pre></div>


	<p>The information we generated in our last result was created in the form of a JSON object that contained our userID, and the userDoc, which were generated with the <strong>User.create</strong> function. This information is used for <strong>&#39;Session.makeVerification&#39;</strong> to now generate an email which is used to verify that the email the user used is actually theirs. If not, they won&#39;t be able to access their account. To see an example of the document that would be entered, look at <a href="">part 0</a></p>

	<p>If you care to take this extra step of verification in your accounts, please refer to the next post, <a href="">part 2</a> about email verification with Couchbase, Nodemailer and the Sengrid API.</p>

	<p>Thank you all for your time, and I hope this was useful. Please drop a comment below with any questions, feedback, or criticism.</p>


</body></html>